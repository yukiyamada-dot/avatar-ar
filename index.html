<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zappar Permission Test (fixed)</title>
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<!-- ❶ Zapparを新しめのバージョンに＆deferで読み込み、onload待ち -->
<script src="https://libs.zappar.com/zappar-aframe/2.1.0/zappar-aframe.js" defer></script>
<style>
  body{margin:0;background:#000;color:#fff;font:14px/1.5 system-ui;padding:16px}
  #log{white-space:pre-wrap;background:#111;padding:10px;border-radius:10px;margin-top:12px}
  button{padding:10px 14px;border:0;border-radius:10px}
  a-scene{display:none}
</style>

<h1>Zappar Permission Test</h1>
<p>Safariで<strong>直接</strong>開き、「権限を試す」を押してください。</p>
<button id="btn">権限を試す</button>
<pre id="log"></pre>

<zappar-compatibility-ui></zappar-compatibility-ui>
<zappar-permission-ui></zappar-permission-ui>

<a-scene id="scene" embedded vr-mode-ui="enabled:false">
  <a-entity zappar-camera="user-facing:false" camera></a-entity>
</a-scene>

<script>
const log = (...a)=>{document.getElementById('log').textContent += a.join(' ')+'\n';};

// ❷ ZapparAFrameのロードを待つユーティリティ
function waitForZappar(timeoutMs=5000){
  return new Promise((resolve,reject)=>{
    const start=Date.now();
    (function tick(){
      if (window.ZapparAFrame) return resolve();
      if (Date.now()-start>timeoutMs) return reject(new Error('ZapparAFrame not loaded'));
      requestAnimationFrame(tick);
    })();
  });
}

document.getElementById('btn').onclick = async ()=>{
  try{
    log('step0: wait for ZapparAFrame…');
    await waitForZappar().catch(e=>{ log('  warn:', e.message); });

    // ❸ 存在チェックしてから権限APIを呼ぶ（なければスキップ）
    if (window.ZapparAFrame?.permission?.requestCameraPermissionsAsync){
      log('step1: Zappar permission request…');
      const granted = await ZapparAFrame.permission.requestCameraPermissionsAsync();
      log('  result:', granted);
      if(!granted){ log('⛔ Zappar permission denied'); return; }
    } else {
      log('step1: Zappar permission API not found → スキップ');
    }

    log('step2: getUserMedia…');
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact:'environment' } }
    }).catch(async (e)=>{
      log('  environment failed:', e && e.name ? `${e.name}: ${e.message}` : e);
      return navigator.mediaDevices.getUserMedia({ video:true });
    });
    log('  gUM success, tracks=', stream.getVideoTracks().length);
    stream.getTracks().forEach(t=>t.stop());

    log('step3: show scene');
    document.getElementById('scene').style.display = 'block';
    log('✅ DONE');
  }catch(e){
    log('❌ error:', e && e.name ? `${e.name}: ${e.message}` : e);
  }
};
</script>
