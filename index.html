<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Yuki WebAR (Markerless + Animation, iPhoneå¯¾å¿œ)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- Zappar for A-Frame -->
  <script src="https://libs.zappar.com/zappar-aframe/2.0.0/zappar-aframe.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; }
    #gate {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px; background:#000; color:#fff; z-index: 9999; text-align:center; padding: 24px;
    }
    #gate button {
      pointer-events:auto; appearance:none; border:0; border-radius: 14px; padding: 12px 16px;
      font: 15px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background:#fff; color:#000; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    #hint {
      position: fixed; left: 10px; top: 10px; color:#fff; font:12px/1.4 system-ui; opacity:.85;
      text-shadow: 0 1px 2px rgba(0,0,0,.6); z-index: 10;
    }
    a-scene { display: none; } /* æ¨©é™ãŒé€šã£ãŸã‚‰è¡¨ç¤ºã«åˆ‡æ›¿ */
  </style>
</head>
<body>
  <div id="hint">ğŸ“± Safariã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ä¸‹ã®ãƒœã‚¿ãƒ³ â†’ ã‚«ãƒ¡ãƒ©è¨±å¯ â†’ å‘¨å›²ã‚’è¦‹å›ã—ã¦ã‹ã‚‰ç”»é¢ã‚¿ãƒƒãƒ—ã§å›ºå®š</div>

  <!-- äº’æ›æ€§ï¼†æ¨©é™UIï¼ˆZapparå…¬å¼ã®çµ„ã¿è¾¼ã¿ï¼‰ -->
  <zappar-compatibility-ui></zappar-compatibility-ui>
  <zappar-permission-ui></zappar-permission-ui>

  <!-- æ˜ç¤ºæ“ä½œã§æ¨©é™ã‚’ç¢ºå®ŸåŒ–ã™ã‚‹ã‚²ãƒ¼ãƒˆ -->
  <div id="gate">
    <div>ARã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br><b>Safariã§ç›´æ¥</b>ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="startBtn">ARã‚’é–‹å§‹</button>
    <div style="opacity:.75; font-size:12px">
      ã†ã¾ãã„ã‹ãªã„æ™‚ã¯ï¼šè¨­å®š â–¶ï¸ Safari â–¶ï¸ ã‚«ãƒ¡ãƒ© â–¶ï¸ <b>è¨±å¯</b>ï¼ã“ã®ã‚µã‚¤ãƒˆã®è¨­å®šã§ã‚«ãƒ¡ãƒ©<b>è¨±å¯</b>ï¼httpsã§ã‚¢ã‚¯ã‚»ã‚¹
    </div>
  </div>

  <!-- A-Frame + Zapparï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼‰ -->
  <a-scene
    id="scene"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    embedded
    loading-screen="enabled:false"
  >
    <!-- èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ -->
    <a-entity id="zapparCamera" zappar-camera="user-facing:false" camera></a-entity>

    <!-- ãƒ©ã‚¤ãƒˆ -->
    <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>

    <!-- ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¹ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼‰ -->
    <a-entity id="anchor" zappar-instant="placement-mode: true">
      <!-- é…ç½®ã‚¬ã‚¤ãƒ‰ï¼ˆç™½ãƒªãƒ³ã‚°ï¼‰ -->
      <a-entity
        id="placement"
        geometry="primitive: ring; radiusInner: 0.08; radiusOuter: 0.1"
        rotation="-90 0 0"
        material="color: #ffffff; metalness:0.2; roughness:0.5; opacity:0.9"
      ></a-entity>

      <!-- GLBï¼ˆã‚¢ãƒ‹ãƒ¡å…¥ã‚Šï¼‰ -->
      <a-entity id="yuki"
        gltf-model="Yuki.glb"
        position="0 0 0"
        rotation="0 180 0"
        scale="0.6 0.6 0.6"
        visible="false"
        animation-mixer="clip: *; loop: repeat; timeScale: 1">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    const gate = document.getElementById('gate');
    const scene = document.getElementById('scene');
    const anchor = document.getElementById('anchor');
    const placement = document.getElementById('placement');
    const yuki = document.getElementById('yuki');

    function updateUI() {
      const isPlacing = anchor.getAttribute('zappar-instant').placementMode;
      placement.setAttribute('visible', isPlacing);
      yuki.setAttribute('visible', !isPlacing);
    }

    // ç”»é¢ã‚¿ãƒƒãƒ—ã§å›ºå®šï¼å†é…ç½®
    document.body.addEventListener('click', (e) => {
      // gateãŒè¡¨ç¤ºä¸­ã¯ç„¡è¦–
      if (gate.style.display !== 'none') return;
      const isPlacing = anchor.getAttribute('zappar-instant').placementMode;
      if (isPlacing) {
        anchor.setAttribute('zappar-instant', 'placement-mode: false'); // å›ºå®š
        updateUI();
      }
    });

    // ã€ŒARã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§æ¨©é™ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å¿…ãšå‡ºã™
    document.getElementById('startBtn').addEventListener('click', async () => {
      try {
        // ä¸€åº¦ getUserMedia ã‚’æ˜ç¤ºæ“ä½œã§å‘¼ã‚“ã§æ¨©é™ã‚’ç¢ºå®ŸåŒ–ï¼ˆã™ãåœæ­¢ï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: 'environment' } }
        }).catch(() => navigator.mediaDevices.getUserMedia({ video: true }));
        stream.getTracks().forEach(t => t.stop());

        // æ¨©é™OKãªã‚‰Zapparã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤º
        gate.style.display = 'none';
        scene.style.display = 'block';
        updateUI();
      } catch (e) {
        alert('ã‚«ãƒ¡ãƒ©æ¨©é™ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\nè¨­å®š > Safari > ã‚«ãƒ¡ãƒ© ã‚’ã€Œè¨±å¯ã€ã«ã—ã€Safariã§httpsãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚\n\nè©³ç´°: ' + (e && e.message ? e.message : e));
      }
    });
  </script>
</body>
</html>
