<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Yuki WebAR (Markerless + Animation, iPhone対応)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- Zappar for A-Frame -->
  <script src="https://libs.zappar.com/zappar-aframe/2.0.0/zappar-aframe.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; }
    #gate {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px; background:#000; color:#fff; z-index: 9999; text-align:center; padding: 24px;
    }
    #gate button {
      pointer-events:auto; appearance:none; border:0; border-radius: 14px; padding: 12px 16px;
      font: 15px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background:#fff; color:#000; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    #hint {
      position: fixed; left: 10px; top: 10px; color:#fff; font:12px/1.4 system-ui; opacity:.85;
      text-shadow: 0 1px 2px rgba(0,0,0,.6); z-index: 10;
    }
    a-scene { display: none; } /* 権限が通ったら表示に切替 */
  </style>
</head>
<body>
  <div id="hint">📱 Safariでこのページを開き、下のボタン → カメラ許可 → 周囲を見回してから画面タップで固定</div>

  <!-- 互換性＆権限UI（Zappar公式の組み込み） -->
  <zappar-compatibility-ui></zappar-compatibility-ui>
  <zappar-permission-ui></zappar-permission-ui>

  <!-- 明示操作で権限を確実化するゲート -->
  <div id="gate">
    <div>ARを開始するにはカメラ許可が必要です。<br><b>Safariで直接</b>このページを開き、下のボタンを押してください。</div>
    <button id="startBtn">ARを開始</button>
    <div style="opacity:.75; font-size:12px">
      うまくいかない時は：設定 ▶︎ Safari ▶︎ カメラ ▶︎ <b>許可</b>／このサイトの設定でカメラ<b>許可</b>／httpsでアクセス
    </div>
  </div>

  <!-- A-Frame + Zappar（ワールドトラッキング） -->
  <a-scene
    id="scene"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    embedded
    loading-screen="enabled:false"
  >
    <!-- 背面カメラ優先 -->
    <a-entity id="zapparCamera" zappar-camera="user-facing:false" camera></a-entity>

    <!-- ライト -->
    <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>

    <!-- マーカーレス（インスタントワールドトラッキング） -->
    <a-entity id="anchor" zappar-instant="placement-mode: true">
      <!-- 配置ガイド（白リング） -->
      <a-entity
        id="placement"
        geometry="primitive: ring; radiusInner: 0.08; radiusOuter: 0.1"
        rotation="-90 0 0"
        material="color: #ffffff; metalness:0.2; roughness:0.5; opacity:0.9"
      ></a-entity>

      <!-- GLB（アニメ入り） -->
      <a-entity id="yuki"
        gltf-model="Yuki.glb"
        position="0 0 0"
        rotation="0 180 0"
        scale="0.6 0.6 0.6"
        visible="false"
        animation-mixer="clip: *; loop: repeat; timeScale: 1">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    const gate = document.getElementById('gate');
    const scene = document.getElementById('scene');
    const anchor = document.getElementById('anchor');
    const placement = document.getElementById('placement');
    const yuki = document.getElementById('yuki');

    function updateUI() {
      const isPlacing = anchor.getAttribute('zappar-instant').placementMode;
      placement.setAttribute('visible', isPlacing);
      yuki.setAttribute('visible', !isPlacing);
    }

    // 画面タップで固定／再配置
    document.body.addEventListener('click', (e) => {
      // gateが表示中は無視
      if (gate.style.display !== 'none') return;
      const isPlacing = anchor.getAttribute('zappar-instant').placementMode;
      if (isPlacing) {
        anchor.setAttribute('zappar-instant', 'placement-mode: false'); // 固定
        updateUI();
      }
    });

    // 「ARを開始」ボタン：ユーザー操作で権限ダイアログを必ず出す
    document.getElementById('startBtn').addEventListener('click', async () => {
      try {
        // 一度 getUserMedia を明示操作で呼んで権限を確実化（すぐ停止）
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: 'environment' } }
        }).catch(() => navigator.mediaDevices.getUserMedia({ video: true }));
        stream.getTracks().forEach(t => t.stop());

        // 権限OKならZapparシーンを表示
        gate.style.display = 'none';
        scene.style.display = 'block';
        updateUI();
      } catch (e) {
        alert('カメラ権限が得られませんでした。\n設定 > Safari > カメラ を「許可」にし、Safariでhttpsページを開いてください。\n\n詳細: ' + (e && e.message ? e.message : e));
      }
    });
  </script>
</body>
</html>
