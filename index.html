<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Yuki AR (iPhoneå¯¾å¿œãƒ»ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ)</title>

  <!-- A-Frame & AR.jsï¼ˆiOS Safariå¯¾å¿œï¼‰ -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar-js-org@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; }
    #gate {
      position: fixed; inset: 0; display:flex; align-items:center; justify-content:center;
      background:#000; color:#fff; z-index: 9999; flex-direction:column; gap:12px; padding:24px; text-align:center;
    }
    #gate button {
      padding:12px 16px; font-size:16px; border:0; border-radius:12px; background:#fff; color:#000;
    }
    .hint {
      position: fixed; left: 10px; bottom: 10px;
      color: #fff; font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      opacity: .85; z-index: 10;
    }
    #err {
      position: fixed; top: 10px; left: 10px; right:10px;
      color:#fff; background: rgba(255,0,0,.3); padding:8px 12px; border-radius:8px; font: 12px/1.4 system-ui;
      display:none; z-index:10;
    }
  </style>
</head>
<body>
  <!-- ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’â€œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œâ€ã§ç¢ºå®Ÿã«å‡ºã™ãŸã‚ã®ã‚²ãƒ¼ãƒˆ -->
  <div id="gate">
    <div>ğŸ“· ARã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br>Safariã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <button id="startBtn">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <div style="opacity:.7; font-size:12px">
      â€»iOS: è¨­å®š > Safari > ã‚«ãƒ¡ãƒ© ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <div id="err"></div>
  <div class="hint">ğŸ“Œ HIROãƒãƒ¼ã‚«ãƒ¼ã«ã‹ã–ã™ã¨YukiãŒã‚¢ãƒ‹ãƒ¡å†ç”Ÿã§å‡ºç¾ã—ã¾ã™ã€‚</div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="alpha: true; antialias: true; physicallyCorrectLights: true;"
    arjs="sourceType: webcam; facingMode: environment; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false;"
  >
    <a-assets>
      <a-asset-item id="yuki" src="Yuki.glb"></a-asset-item>
    </a-assets>

    <!-- HIROãƒãƒ¼ã‚«ãƒ¼ä¸Šã«è¡¨ç¤º -->
    <a-marker preset="hiro">
      <a-entity
        gltf-model="#yuki"
        animation-mixer="clip: *; loop: repeat; timeScale: 1"
        position="0 0 0"
        rotation="0 0 0"
        scale="0.6 0.6 0.6"
      ></a-entity>
      <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const gate = document.getElementById('gate');
    const errBox = document.getElementById('err');
    const startBtn = document.getElementById('startBtn');

    function showError(msg){
      errBox.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + msg;
      errBox.style.display = 'block';
    }

    async function requestCameraPermission() {
      // æ˜ç¤ºæ“ä½œã§ getUserMedia â†’ è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        }).catch(async () => {
          // èƒŒé¢ãŒå–ã‚Œãªã„ç«¯æœ«å‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          return navigator.mediaDevices.getUserMedia({ video: true });
        });
        // ã™ãåœæ­¢ï¼ˆAR.jsã«å§”ã­ã‚‹ï¼‰
        stream.getTracks().forEach(t => t.stop());
        gate.style.display = 'none';
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      }
    }

    startBtn.addEventListener('click', requestCameraPermission);

    // è¿½åŠ : iOSã§æ¨©é™ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯è‡ªå‹•ã§ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
    (async () => {
      if (navigator.permissions && navigator.permissions.query) {
        try {
          const s = await navigator.permissions.query({ name: 'camera' });
          if (s.state === 'granted') gate.style.display = 'none';
        } catch(_) {}
      }
    })();
  </script>
</body>
</html>
