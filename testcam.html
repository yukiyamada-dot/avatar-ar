<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Camera Permission Test</title>
<style>
  body{margin:0;background:#000;color:#fff;font:14px/1.5 system-ui;padding:16px}
  #v{width:100%;max-width:520px;aspect-ratio:4/3;background:#111;border-radius:10px}
  #log{white-space:pre-wrap;background:#111;padding:10px;border-radius:10px;margin-top:12px}
  button{padding:10px 14px;border:0;border-radius:10px}
</style>
<h1>Camera Permission Test</h1>
<p>Safariでこのページを<strong>直接</strong>開き、ボタンを押してください（HTTPS必須）。</p>
<button id="btn">カメラを試す</button>
<video id="v" autoplay playsinline muted></video>
<pre id="log"></pre>
<script>
const v = document.getElementById('v');
const logEl = document.getElementById('log');
const log = (...a)=>{logEl.textContent += a.join(' ')+'\n';};
document.getElementById('btn').onclick = async () => {
  log('protocol:', location.protocol);
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact:'environment' } }
    }).catch(async (e)=>{
      log('背面指定エラー:', e && e.name ? `${e.name}: ${e.message}` : e);
      return navigator.mediaDevices.getUserMedia({ video:true });
    });
    v.srcObject = stream;
    log('✅ getUserMedia success: tracks=', stream.getVideoTracks().length);
    setTimeout(()=>stream.getTracks().forEach(t=>t.stop()), 3000);
  } catch(e) {
    log('❌ getUserMedia error:', e && e.name ? `${e.name}: ${e.message}` : e);
  }
  if (navigator.mediaDevices?.enumerateDevices) {
    const devs = await navigator.mediaDevices.enumerateDevices();
    log('devices:', JSON.stringify(devs.map(d=>({kind:d.kind,label:d.label})), null, 2));
  }
};
</script>
